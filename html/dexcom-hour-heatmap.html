<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>
			Week by Week Summaries of Dexcom Data with D3
		</title>
		<script type="text/javascript" src="../d3-branch/js/d3.v3.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
		<link href="../d3-branch/css/bootstrap.min.css" rel="stylesheet" type="text/css">
		<style type="text/css">
			.axis path, .axis line {
					  fill: none;
					  stroke: #000;
					  shape-rendering: crispEdges;
					}
			text {
				font-family: sans-serif;
				font-size: 12px;
			}
/* crispEdges incompatible with rounded corners */
/*			rect {
				shape-rendering: crispEdges;
			}*/
		</style>
	</head>
	<body>
		<div class="container">
			<div class="hero-unit" id="main">
				<p class="lead">
					Dexcom Data: Week by Week
				</p>
				<div>
					<h4 id="week-of"></h4>
					<div id="week-buttons" class="btn-group pull-right">
						<button id="previous-week" class="btn disabled">Previous Week</button>
						<button id="next-week" class="btn">Next Week</button>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			var margin = {top: 20, right: 10, bottom: 20, left: 70};
			// 60px of padding (difference between left and right margins) to allow for y-axis on left
			var pad = margin.left - margin.right;

			// 780 x 440 will be dimensions of SVG element
			var w = 780 - margin.left - margin.right;
			var h = 440 - margin.top - margin.bottom;

			// set up svg
			var svg = d3.select("#main")
				.append("svg:svg")
				.attr("width", w + margin.left + margin.right)
				.attr("height", h + margin.top + margin.bottom)
				.append("svg:g")
				// translate changes the relative 0,0 of the elements (and all embedded elements) to the specified x, y
				// effectively this sets the origin point of the actual data viz to the inside of the top and left margins
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			var dataset;
			var dataByHour = [];
			var xScale;
			var yScale;
			var yAxis;
			var currentWeek;

			d3.json("../dexcom_weeks.json", function(error, json) {
				if (error) { return console.warn(error); }
				weeks = json["Weeks"];
				currentWeek = weeks[0];
				loadFirstWeek(currentWeek);
			});

			var loadFirstWeek = function(currentWeek) {
				yScale = d3.scale.linear()
					// domain is 20 to 420 so that Lo and Hi values changed to 39 and 401 will be included, potentially
					.domain([20, 420])
					// range goes from h to 0 because of the lovely backwards way in which the SVG coord system works
					.range([h, 0]);
				xScale = d3.scale.linear()
					// domain is 0 to 24 so that all hours of 24-hour day are included
					.domain([0, 24])
					.rangeRound([0, w]);
				dataset = d3.layout.histogram()
					.value(function(d) { return d['blood_glucose']; })
					// group the data into 20 bins
					.bins(yScale.ticks(20))
					(currentWeek['Timestamped Readings']);
				for (i = 0; i < dataset.length; i++) {
					data = d3.layout.histogram()
						.value(function(d) {
							// TODO: remove manual timezone offset once fixed in Python
							var t = new Date(d['timestamp'] + '-05:00');
							h = t.getHours();
							return h;
						})
						// group the data into bins by time of day
						.bins(xScale.ticks(24))
						(dataset[i]);
					dataByHour.push(data);
				}
			};

			// advance to next week of data
			d3.select('#next-week').on('click', function() {
				if (!($(this).hasClass('disabled'))) {
					var newIndex = weeks.indexOf(currentWeek) + 1;
					currentWeek = weeks[newIndex];
					newWeek(currentWeek);
					updateButton(newIndex);
				}
			});

			// go back to previous week of data
			d3.select('#previous-week').on('click', function() {
				if (!($(this).hasClass('disabled'))) {
					var newIndex = weeks.indexOf(currentWeek) - 1;
					currentWeek = weeks[newIndex];
					newWeek(currentWeek);
					updateButton(newIndex);
				}
			});

			var updateButton = function(weekIndex) {
				if ((weekIndex > 0) && (weekIndex < weeks.length - 1)) {
					$('#week-buttons button').removeClass('disabled');
				}
				else if (weekIndex == 0) {
					$('#previous-week').addClass('disabled');
				}
				else if (weekIndex == weeks.length -1) {
					$('#next-week').addClass('disabled');
				}
			};
		</script>
	</body>
</html>