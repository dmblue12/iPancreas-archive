<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>
			Week by Week Summaries of Dexcom Data with D3
		</title>
		<script type="text/javascript" src="../d3-branch/js/d3.v3.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
		<link href="../d3-branch/css/bootstrap.min.css" rel="stylesheet" type="text/css">
		<style type="text/css">
			.axis path, .axis line {
					  fill: none;
					  stroke: #000;
					  shape-rendering: crispEdges;
					}
			text {
				font-family: sans-serif;
				font-size: 12px;
			}
/* crispEdges incompatible with rounded corners */
/*			rect {
				shape-rendering: crispEdges;
			}*/
		</style>
	</head>
	<body>
		<div class="container">
			<div class="hero-unit" id="main">
				<p class="lead">
					Dexcom Data: Week by Week
				</p>
				<div>
					<h4 id="week-of"></h4>
					<div id="week-buttons" class="btn-group pull-right">
						<button id="previous-week" class="btn disabled">Previous Week</button>
						<button id="next-week" class="btn">Next Week</button>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			// for retrieving ISO 8601 week number
			// from this Gist: https://gist.github.com/dblock/1081513
			var getWeek = function( d ) { 
				// Create a copy of this date object  
				var target = new Date(d.valueOf());  
				  
				// ISO week date weeks start on monday so correct the day number  
				var dayNr = (d.getDay() + 6) % 7;
				 
				// Set the target to the thursday of this week so the target date is in the right year  
				target.setDate(target.getDate() - dayNr + 3);  
				 
				// ISO 8601 states that week 1 is the week with january 4th in it  
				var jan4 = new Date(target.getFullYear(), 0, 4);  
				 
				// Number of days between target date and january 4th  
				var dayDiff = (target - jan4) / 86400000;    
				 
				// Calculate week number: Week 1 (january 4th) plus the number of weeks between target date and january 4th    
				var weekNr = 1 + Math.ceil(dayDiff / 7);    
				 
				return weekNr;
			};
			var margin = {top: 20, right: 10, bottom: 20, left: 70};
			var pad = margin.left - margin.right;
			var w = 780 - margin.left - margin.right;
			var h = 440 - margin.top - margin.bottom;
			// set up svg
			var svg = d3.select("#main")
				.append("svg:svg")
				.attr("width", w + margin.left + margin.right)
				.attr("height", h + margin.top + margin.bottom)
				.append("svg:g")
				.attr("transform", "translate(" + pad + "," + margin.top + ")");
			var dataset;
			var xScale;
			var yScale;
			var yAxis;
			var week_batches = new Array();
			var weekIndex = 0;

			d3.json("../dexcom.json", function(error, json) {
				if (error) return console.warn(error);
				readings = json["Readings"];
				last_week = "";
				var week = new Object();
				week.readings = new Array();
				for (i = 0; i < readings.length; i++) {
					dt = new Date(readings[i]["UTC_timestamp"]);
					current_week = getWeek(dt);
					if (last_week !== current_week) {
						if (week.readings.length !== 0) {
							week_batches.push(week);
						}
						week =  { weekof: dt.toLocaleDateString(), readings: [readings[i]]};
					}
					else {
						week.readings.push(readings[i]);
					}
					last_week = current_week;
				};
				// first load of data
				loadFirstWeek(weekIndex);
			});

			var loadFirstWeek = function(weekIndex) {
				yScale = d3.scale.linear()
					.domain([20, 420])
					.range([h, 0]);
				dataset = d3.layout.histogram()
					.value(function(d) { return parseInt(d.blood_glucose); })
					.bins(yScale.ticks(20))
					(week_batches[weekIndex].readings);
				$('#week-of').html("Week of " + week_batches[weekIndex].weekof);
				xScale = d3.scale.linear()
					.domain([0, d3.max(dataset, function(d) { return d.y; })])
					.range([0, w]);
				yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left");
				svg.selectAll("rect")
					.data(dataset)
					.enter()
					.append("svg:rect")
					// attributes that don't need updated
					.attr({
						rx: 5,
						ry: 5
					})
					// attributes that do need updated
					// TODO: factor these out as a function?
					.attr({
						x: function(d) {
							return (w - xScale(d.y)) / 2 + (margin.left - pad) / 2;
						},
						y: function(d) {
							return yScale(d.x) - yScale(dataset[dataset.length - 1].x);
						},
						width: function(d) {
							return xScale(d.y);
						},
						height: function(d, i) {
							// creating my own sort of rangeBands here, with 10% padding
							return yScale(dataset[dataset.length - 1].x) * 0.9;
						},
						fill: function(d) {
							if (d.x < 80) {
								return "rgb(" + Math.round((xScale(d.y) / w) * 255) + ", 0, 0)";
							}
							else if ((d.x >= 80) && (d.x < 140)) {
								return "rgb(0, 0, " + Math.round((xScale(d.y) / w) * 255) + ")";
							}
							else if (d.x >= 140) {
								return "rgb(" + Math.round((xScale(d.y) / w) * 255) + ", 0, 0)";
							}
						}
					});
				svg.append("svg:g")
					.attr("class", "y axis")
					.call(yAxis);
				// y-axis label
				svg.append("svg:text")
					.attr("class", "y label")
					.attr("text-anchor", "middle")
					.attr("y", -pad)
					.attr("x", -h/2)
					.attr("dy", ".75em")
					.attr("transform", "rotate(-90)")
					.text("Blood Glucose in mg/dL");
				// def linear gradient for legend: blue
				blueLinearDef = svg.append("svg:defs")
					.append("svg:linearGradient")
					.attr({
						id: "blueLinear",
						x1: "0%",
						y1: "0%",
						x2: "100%",
						y2: "0%",
						spreadMethod: "pad"
					});
				blueLinearDef.append("svg:stop")
					.attr("offset", "0%")
					.attr("stop-color", "#0000FF")
					.attr("stop-opacity", "1");
				blueLinearDef.append("svg:stop")
					.attr("offset", "100%")
					.attr("stop-color", "#000000")
					.attr("stop-opacity", "1");
				// def linear gradient for legend: red
				redLinearDef = svg.append("svg:defs")
					.append("svg:linearGradient")
					.attr({
						id: "redLinear",
						x1: "0%",
						y1: "0%",
						x2: "100%",
						y2: "0%",
						spreadMethod: "pad"
					});
				redLinearDef.append("svg:stop")
					.attr("offset", "0%")
					.attr("stop-color", "#FF0000")
					.attr("stop-opacity", "1");
				redLinearDef.append("svg:stop")
					.attr("offset", "100%")
					.attr("stop-color", "#000000")
					.attr("stop-opacity", "1");
				// TODO: get rid of magic numbers here determining widths and heights of things
				// add group for target range legend
				legendXPos = w - (pad - margin.right) - (pad + 40);
				targetLegend = svg.append("svg:g")
					.attr({
						transform: "translate(" + legendXPos + "," + 0 + ")",
						width: 160,
						height: 60
					});
				// add gradient square for target range legend
				targetLegend.append("svg:rect")
					.attr("x", 0)
					.attr("y", 5)
					.attr("rx", 5)
					.attr("ry", 5)
					.attr("width", 160)
					.attr("height", 20)
					.attr("stroke", "#DCDCDC")
					.attr("stroke-width", 3)
					.style("fill", "url(#blueLinear)");
				//add legend text: blue
				targetLegend.append("svg:text")
					.attr("x", 80)
					.attr("y", 16)
					.attr("text-anchor", "middle")
					.attr("dominant-baseline", "middle")
					.attr("fill", "#DCDCDC")
					.text("In Target Range");
				// add gradient square for out of target range legend
				targetLegend.append("svg:rect")
					.attr("x", 0)
					.attr("y", 35)
					.attr("rx", 5)
					.attr("ry", 5)
					.attr("width", 160)
					.attr("height", 20)
					.attr("stroke", "#DCDCDC")
					.attr("stroke-width", 3)
					.style("fill", "url(#redLinear)");
				//add legend text: red
				targetLegend.append("svg:text")
					.attr("x", 80)
					.attr("y", 46)
					.attr("text-anchor", "middle")
					.attr("dominant-baseline", "middle")
					.attr("fill", "#DCDCDC")
					.text("Out of Target Range");
			};

			var newWeek = function(weekIndex) {
				// load new week of data into histogram layout
				dataset = d3.layout.histogram()
					.value(function(d) {return parseInt(d.blood_glucose); })
					.bins(yScale.ticks(19))
					(week_batches[weekIndex].readings);
				$('#week-of').html("Week of " + week_batches[weekIndex].weekof);
				// update scales
				xScale.domain([0, d3.max(dataset, function(d) { return d.y; })])
					.range([0, w]);
				// bind new data
				svg.selectAll("rect")
					.data(dataset)
					.transition()
					.attr({
						x: function(d) {
							return (w - xScale(d.y)) / 2 + (margin.left - pad) / 2;
						},
						y: function(d) {
							return yScale(d.x) - yScale(dataset[dataset.length - 1].x);
						},
						width: function(d) {
							return xScale(d.y);
						},
						height: function(d, i) {
							return yScale(dataset[dataset.length - 1].x) * 0.9;
						},
						fill: function(d) {
							if (d.x < 80) {
								return "rgb(" + Math.round((xScale(d.y) / w) * 255) + ", 0, 0)";
							}
							else if ((d.x >= 80) && (d.x < 140)) {
								return "rgb(0, 0, " + Math.round((xScale(d.y) / w) * 255) + ")";
							}
							else if (d.x >= 140) {
								return "rgb(" + Math.round((xScale(d.y) / w) * 255) + ", 0, 0)";
							}
						}
					});
			};

			// advance to next week of data
			d3.select('#next-week').on('click', function() {
				if (!($(this).hasClass('disabled'))) {				
					weekIndex += 1;
					newWeek(weekIndex);
					updateButton(weekIndex);
				}
			});

			// go back to previous week of data
			d3.select('#previous-week').on('click', function() {
				if (!($(this).hasClass('disabled'))) {				
					weekIndex -= 1;
					newWeek(weekIndex);
					updateButton(weekIndex);
				}
			});

			var updateButton = function(weekIndex) {
				if ((weekIndex > 0) && (weekIndex < week_batches.length - 1)) {
					$('#week-buttons button').removeClass('disabled');
				}
				else if (weekIndex == 0) {
					$('#previous-week').addClass('disabled');
				}
				else if (weekIndex == week_batches.length -1) {
					$('#next-week').addClass('disabled');
				}
			};
		</script>
	</body>
</html>