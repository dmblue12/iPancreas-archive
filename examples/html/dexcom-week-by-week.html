<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>
			Week by Week Summaries of Dexcom Data with D3
		</title>
		<script type="text/javascript" src="../d3-branch/js/d3.v3.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
		<link href="../d3-branch/css/bootstrap.min.css" rel="stylesheet" type="text/css">
		<style type="text/css">
			.axis path, .axis line {
					  fill: none;
					  stroke: #000;
					  shape-rendering: crispEdges;
					}
			text {
				font-family: sans-serif;
				font-size: 12px;
			}
/*			rect {
				shape-rendering: crispEdges;
			}*/
		</style>
	</head>
	<body>
		<div class="container">
			<div class="hero-unit" id="main">
				<p class="lead">
					Dexcom Data: Week by Week
				</p>
				<div>
					<h4 id="week-of"></h4>
					<div id="week-buttons" class="btn-group pull-right">
						<button id="previous-week" class="btn disabled">Previous Week</button>
						<button id="next-week" class="btn">Next Week</button>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			// for retrieving ISO 8601 week number
			// from this Gist: https://gist.github.com/dblock/1081513
			var getWeek = function( d ) { 
				// Create a copy of this date object  
				var target = new Date(d.valueOf());  
				  
				// ISO week date weeks start on monday so correct the day number  
				//var dayNr = (d.getDay() + 6) % 7;
				var dayNr = d.getDay();  
				 
				// Set the target to the thursday of this week so the target date is in the right year  
				target.setDate(target.getDate() - dayNr + 3);  
				 
				// ISO 8601 states that week 1 is the week with january 4th in it  
				var jan4 = new Date(target.getFullYear(), 0, 4);  
				 
				// Number of days between target date and january 4th  
				var dayDiff = (target - jan4) / 86400000;    
				 
				// Calculate week number: Week 1 (january 4th) plus the    
				// number of weeks between target date and january 4th    
				var weekNr = 1 + Math.ceil(dayDiff / 7);    
				 
				return weekNr;
			};
			var margin = {top: 20, right: 10, bottom: 20, left: 70};
			var pad = margin.left - margin.right;
			var w = 840 - margin.left - margin.right;
			var h = 440 - margin.top - margin.bottom;
			// set up svg
			var svg = d3.select("#main")
				.append("svg")
				.attr("width", w + margin.left + margin.right)
				.attr("height", h + margin.top + margin.bottom);
			var dataset;
			var xScale;
			var yScale;
			var xAxis;
			var yAxis;
			var bins = [];
			var week_batches = new Array();
			var weekIndex = 0;

			d3.json("../dexcom.json", function(error, json) {
				if (error) return console.warn(error);
				readings = json["Readings"];
				last_week = "";
				var week = new Object();
				week.readings = new Array();
				for (i = 0; i < readings.length; i++) {
					dt = new Date(readings[i]["timestamp"]);
					current_week = getWeek(dt);
					if (last_week !== current_week) {
						if (week.readings.length !== 0) {
							week_batches.push(week);
						}
						week =  { weekof: dt.toLocaleDateString(), readings: [readings[i]]};
					}
					else {
						week.readings.push(readings[i]);
					}
					last_week = current_week;
				};
				// first load of data
				loadFirstWeek(weekIndex);
			});

			var loadFirstWeek = function(weekIndex) {
				dataset = d3.layout.histogram()
					.value(function(d) { return parseInt(d.blood_glucose); })
					.bins(d3.range(45, 405, 20))
					(week_batches[weekIndex].readings);
				$('#week-of').html("Week of " + week_batches[weekIndex].weekof);
				xScale = d3.scale.linear()
					.domain([0, d3.max(dataset, function(d) { return d.y; })])
					.range([0, w]);
				for (i = 0; i < dataset.length; i++) {
					if (dataset[i].y != 0) {
						bins.push(dataset[i].x);
					}
				}
				bins.push(bins[bins.length - 1] + 20);
				yScale = d3.scale.ordinal()
					.domain(bins.reverse())
					.rangeRoundBands([0, h], 0.10);
				yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left");
				svg.selectAll("rect")
					.data(dataset)
					.enter()
					.append("rect")
					.attr({
						x: function(d) {
							return (w - xScale(d.y)) / 2 + margin.left;
						},
						y: function(d, i) {
							// TODO: this is messy and klugey: doesn't work if you change svg height and width
							return h - (h / bins.length - 1) - i * (h / bins.length - 1);
						},
						rx: 5,
						ry: 5,
						width: function(d) {
							return xScale(d.y);
						},
						height: function(d, i) {
							return yScale.rangeBand();
						},
						fill: function(d) {
							if (d.x < 65) {
								return "rgb(" + Math.round((xScale(d.y) / w) * 255) + ", 0, 0)";
							}
							else if ((d.x >= 65) && (d.x < 140)) {
								return "rgb(0, 0, " + Math.round((xScale(d.y) / w) * 255) + ")";
							}
							else if (d.x >= 140) {
								return "rgb(" + Math.round((xScale(d.y) / w) * 255) + ", 0, 0)";
							}
						}
					});
				svg.append("g")
					.attr("class", "y axis")
					.attr("transform", "translate(" + pad + "," + margin.top + ")")
					.call(yAxis);
				// y-axis label
				svg.append("text")
					.attr("class", "y label")
					.attr("text-anchor", "middle")
					.attr("y", 0)
					.attr("x", -h/2)
					.attr("dy", ".75em")
					.attr("transform", "rotate(-90)")
					.text("Blood Glucose in mg/dL");
			};

			var newWeek = function(weekIndex) {
				// load new week of data into histogram layout
				dataset = d3.layout.histogram()
					.value(function(d) {return parseInt(d.blood_glucose); })
					.bins(d3.range(45, 405, 20))
					(week_batches[weekIndex].readings);
				$('#week-of').html("Week of " + week_batches[weekIndex].weekof);
				// update scales
				xScale.domain([0, d3.max(dataset, function(d) { return d.y; })])
					.range([0, w]);
				yScale.domain(bins)
					.rangeRoundBands([0, h], 0.10);
				// bind new data
				svg.selectAll("rect").data(dataset)
					.transition()
					.attr({
						x: function(d) {
							return (w - xScale(d.y)) / 2 + margin.left;
						},
						y: function(d, i) {
							// TODO: this is messy and klugey: doesn't work if you change svg height and width
							return h - (h / bins.length - 1) - i * (h / bins.length - 1);
						},
						width: function(d) {
							return xScale(d.y);
						},
						height: function(d, i) {
							return yScale.rangeBand();
						},
						fill: function(d) {
							if (d.x < 65) {
								return "rgb(" + Math.round((xScale(d.y) / w) * 255) + ", 0, 0)";
							}
							else if ((d.x >= 65) && (d.x < 140)) {
								return "rgb(0, 0, " + Math.round((xScale(d.y) / w) * 255) + ")";
							}
							else if (d.x >= 140) {
								return "rgb(" + Math.round((xScale(d.y) / w) * 255) + ", 0, 0)";
							}
						}
					});
				// update y axis
				svg.select('.y.axis')
					.transition()
					.call(yAxis);
			};

			// advance to next week of data
			d3.select('#next-week').on('click', function() {
				weekIndex += 1;
				newWeek(weekIndex);
				updateButton(weekIndex);
			});

			// go back to previous week of data
			d3.select('#previous-week').on('click', function() {
				weekIndex -= 1;
				newWeek(weekIndex);
				updateButton(weekIndex);
			});

			var updateButton = function(weekIndex) {
				console.log(weekIndex);
				if ((weekIndex > 0) && (weekIndex < week_batches.length - 1)) {
					$('#week-buttons button').removeClass('disabled');
				}
				else if (weekIndex == 0) {
					$('#previous-week').addClass('disabled');
				}
				else if (weekIndex == week_batches.length -1) {
					$('#next-week').addClass('disabled');
				}
			};
		</script>
	</body>
</html>